<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Assistente Financeiro</title>

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2563eb">

<link rel="stylesheet" href="/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<header>ğŸ’™ Assistente Financeiro</header>

<div class="container">

  <!-- MENU -->
  <div class="card">
    <button onclick="mostrar('gastos')">ğŸ“Š Gastos</button>
    <button onclick="mostrar('graficos')">ğŸ“ˆ GrÃ¡ficos</button>
    <button onclick="mostrar('agenda')">ğŸ—“ï¸ Agenda</button>
    <button onclick="mostrar('cofrinho')">ğŸ¦ Cofrinho</button>
    <button onclick="mostrar('contas')">ğŸ’³ Contas</button>
  </div>

  <!-- GASTOS -->
  <section id="gastos" class="card aba">
    <h2>Gastos</h2>

    <input id="descricao" placeholder="DescriÃ§Ã£o do gasto">
    <input id="valor" type="number" placeholder="Valor">
    <input id="categoria" placeholder="Categoria">
    <button onclick="adicionar()">Adicionar</button>

    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Categoria</th>
          <th>DescriÃ§Ã£o</th>
          <th>Valor</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody id="tabela"></tbody>
    </table>

    <h3 id="total"></h3>
  </section>

  <!-- GRÃFICOS -->
  <section id="graficos" class="card aba" style="display:none">
    <h2>GrÃ¡fico por categoria</h2>
    <div class="grafico-container">
      <canvas id="pizza"></canvas>
    </div>
  </section>

  <!-- AGENDA -->
  <section id="agenda" class="card aba" style="display:none">
    <h2>Agenda</h2>
    <p>Em breveâ€¦</p>
  </section>

  <!-- COFRINHO -->
  <section id="cofrinho" class="card aba" style="display:none">
    <h2>Cofrinho</h2>
    <p>Em breveâ€¦</p>
  </section>

  <!-- CONTAS -->
  <section id="contas" class="card aba" style="display:none">
    <h2>Contas a pagar</h2>
    <p>Em breveâ€¦</p>
  </section>

</div>

<!-- BOTÃƒO MODO ESCURO -->
<button class="toggle-dark" onclick="toggleDark()">ğŸŒ™</button>

<script>
const usuario = location.pathname.split('/').pop();
let grafico;

/* NAVEGAÃ‡ÃƒO */
function mostrar(id){
  document.querySelectorAll('.aba').forEach(a=>a.style.display='none');
  document.getElementById(id).style.display='block';
  if(id==='graficos') graficoPizza();
}

/* FORMATAÃ‡ÃƒO */
function real(v){
  return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
}

/* CATEGORIAS */
function renderCategoria(cat){
  const c = cat.toLowerCase();
  if(c.includes('casa')) return `<span class="categoria cat-casa">ğŸ  ${cat}</span>`;
  if(c.includes('merc')) return `<span class="categoria cat-mercado">ğŸ›’ ${cat}</span>`;
  if(c.includes('lazer')) return `<span class="categoria cat-lazer">ğŸ® ${cat}</span>`;
  if(c.includes('uber')||c.includes('gas')) return `<span class="categoria cat-transporte">ğŸš— ${cat}</span>`;
  if(c.includes('comida')||c.includes('aliment')) return `<span class="categoria cat-alimentacao">ğŸ” ${cat}</span>`;
  return `<span class="categoria cat-outros">ğŸ’¸ ${cat}</span>`;
}

/* CARREGAR DADOS */
function carregar(){
  fetch('/api/dados/'+usuario)
  .then(r=>r.json())
  .then(d=>{
    let total=0;
    tabela.innerHTML='';
    d.movimentos.forEach(g=>{
      total+=g.valor;
      tabela.innerHTML+=`
        <tr>
          <td>${g.data}</td>
          <td>${renderCategoria(g.categoria)}</td>
          <td>${g.descricao}</td>
          <td>${real(g.valor)}</td>
          <td>
            <button onclick="editar(${g.id},'${g.descricao}','${g.categoria}',${g.valor})">âœï¸</button>
            <button onclick="excluir(${g.id})">ğŸ—‘ï¸</button>
          </td>
        </tr>`;
    });
    total.innerText='Total: '+real(total);
  });
}

/* CRUD */
function adicionar(){
  fetch('/api/gasto/'+usuario,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      descricao:descricao.value,
      valor:valor.value,
      categoria:categoria.value
    })
  }).then(carregar);
}

function excluir(id){
  fetch('/api/gasto/'+id,{method:'DELETE'}).then(carregar);
}

function editar(id,d,c,v){
  const nd=prompt('DescriÃ§Ã£o',d);
  const nc=prompt('Categoria',c);
  const nv=prompt('Valor',v);
  fetch('/api/gasto/'+id,{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({descricao:nd,categoria:nc,valor:nv})
  }).then(carregar);
}

/* GRÃFICO */
function graficoPizza(){
  fetch('/api/dados/'+usuario)
  .then(r=>r.json())
  .then(d=>{
    const cat={};
    d.movimentos.forEach(g=>cat[g.categoria]=(cat[g.categoria]||0)+g.valor);
    if(grafico)grafico.destroy();
    grafico=new Chart(pizza,{
      type:'pie',
      data:{
        labels:Object.keys(cat),
        datasets:[{data:Object.values(cat)}]
      }
    });
  });
}

/* MODO ESCURO */
function toggleDark(){
  document.body.classList.toggle('dark');
  const ativo=document.body.classList.contains('dark');
  localStorage.setItem('modo-escuro',ativo?'1':'0');
  document.querySelector('.toggle-dark').innerText=ativo?'â˜€ï¸':'ğŸŒ™';
}

if(localStorage.getItem('modo-escuro')==='1'){
  document.body.classList.add('dark');
  document.querySelector('.toggle-dark').innerText='â˜€ï¸';
}

/* SERVICE WORKER (PWA) */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js');
}

carregar();
</script>

</body>
</html>
