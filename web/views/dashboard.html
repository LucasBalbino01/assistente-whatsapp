<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Assistente Financeiro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" href="/icon-512.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  background:#020617;
  color:#e5e7eb;
  font-family:'Segoe UI',Arial,sans-serif;
}

header{
  padding:18px;
  text-align:center;
  font-size:20px;
  font-weight:700;
  border-bottom:1px solid #1e293b;
}

.container{
  padding:16px;
  padding-bottom:100px;
  max-width:1100px;
  margin:auto;
}

.aba{display:none}

.card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:20px;
  padding:18px;
  margin-bottom:18px;
}

.resumo{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:14px;
}

.resumo div{
  border:1px solid #1e293b;
  border-radius:18px;
  padding:14px;
  text-align:center;
}

.resumo h3{font-size:13px;opacity:.8}
.resumo strong{font-size:20px;color:#facc15}

input{
  width:100%;
  padding:14px;
  margin-bottom:10px;
  border-radius:12px;
  border:1px solid #334155;
  background:#020617;
  color:#e5e7eb;
}

button{
  width:100%;
  padding:14px;
  border-radius:999px;
  border:none;
  background:#facc15;
  color:#020617;
  font-weight:600;
}

.item{
  padding:12px 0;
  border-bottom:1px solid #1e293b;
}

canvas{max-width:100%}

.nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#020617;
  border-top:1px solid #1e293b;
  display:flex;
  justify-content:space-around;
  padding:10px 0;
}

.nav button{
  background:none;
  color:#e5e7eb;
  font-size:12px;
}
</style>
</head>

<body>

<header>ğŸ’™ Assistente Financeiro</header>

<div class="container">

<!-- ================= RESUMO ================= -->
<section id="resumo" class="aba" style="display:block">

  <div class="resumo">
    <div>
      <h3>Total gasto</h3>
      <strong id="totalGasto">R$ 0</strong>
    </div>
    <div>
      <h3>Categorias</h3>
      <strong id="totalCat">0</strong>
    </div>
  </div>

  <div class="card">
    <h3>ğŸ“‹ Ãšltimos gastos</h3>
    <div id="listaResumo"></div>
  </div>

  <div class="card">
    <h3>ğŸ“ˆ GrÃ¡ficos</h3>
    <canvas id="pizza"></canvas>
    <canvas id="barra" style="margin-top:20px"></canvas>
  </div>

</section>

<!-- ================= GASTOS ================= -->
<section id="gastos" class="aba">
  <div class="card">
    <h3>ğŸ“Š Gastos</h3>
    <input id="descricao" placeholder="DescriÃ§Ã£o">
    <input id="valor" type="number" placeholder="Valor">
    <input id="categoria" placeholder="Categoria">
    <button onclick="addGasto()">Adicionar</button>
  </div>

  <div class="card" id="listaGastos"></div>
</section>

<!-- ================= AGENDA ================= -->
<section id="agenda" class="aba">
  <div class="card">
    <h3>ğŸ—“ï¸ Agenda</h3>
    <input id="tituloAgenda" placeholder="TÃ­tulo">
    <input id="dataAgenda" type="date">
    <input id="horaAgenda" type="time">
    <button onclick="addLembrete()">Salvar</button>
  </div>
  <div class="card" id="listaAgenda"></div>
</section>

<!-- ================= COFRINHO ================= -->
<section id="cofrinho" class="aba">
  <div class="card">
    <h3>ğŸ¦ Cofrinho</h3>
    <input id="nomeMeta" placeholder="Meta">
    <input id="valorMeta" type="number" placeholder="Valor">
    <button onclick="addCofrinho()">Criar</button>
  </div>
  <div class="card" id="listaCofrinhos"></div>
</section>

<!-- ================= CONTAS ================= -->
<section id="contas" class="aba">
  <div class="card">
    <h3>ğŸ’³ Contas a pagar</h3>
    <input id="contaDesc" placeholder="DescriÃ§Ã£o">
    <input id="contaValor" type="number" placeholder="Valor">
    <input id="contaVenc" type="date">
    <button onclick="addConta()">Adicionar</button>
  </div>
  <div class="card" id="listaContas"></div>
</section>

</div>

<!-- MENU -->
<div class="nav">
  <button onclick="mostrar('resumo')">ğŸ <br>Resumo</button>
  <button onclick="mostrar('gastos')">ğŸ“Š<br>Gastos</button>
  <button onclick="mostrar('agenda')">ğŸ—“ï¸<br>Agenda</button>
  <button onclick="mostrar('cofrinho')">ğŸ¦<br>Cofrinho</button>
  <button onclick="mostrar('contas')">ğŸ’³<br>Contas</button>
</div>

<script>
const usuario = location.pathname.split('/').pop();
let pizzaChart, barraChart;

function mostrar(id){
  document.querySelectorAll('.aba').forEach(a=>a.style.display='none');
  document.getElementById(id).style.display='block';
}

function real(v){
  return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
}

/* ================= GASTOS ================= */
function addGasto(){
  fetch('/api/gasto/'+usuario,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      descricao:descricao.value,
      valor:valor.value,
      categoria:categoria.value
    })
  }).then(load);
}

function load(){
  fetch('/api/dados/'+usuario)
  .then(r=>r.json())
  .then(d=>{
    let total=0;
    const cat={};
    listaResumo.innerHTML='';
    listaGastos.innerHTML='';

    d.movimentos.forEach(g=>{
      total+=g.valor;
      cat[g.categoria]=(cat[g.categoria]||0)+g.valor;

      listaResumo.innerHTML+=`
        <div class="item">
          ${g.descricao} â€¢ ${real(g.valor)}
        </div>`;

      listaGastos.innerHTML+=`
        <div class="item">
          <strong>${g.descricao}</strong><br>
          <small>${g.categoria} â€¢ ${real(g.valor)}</small>
        </div>`;
    });

    totalGasto.innerText=real(total);
    totalCat.innerText=Object.keys(cat).length;

    if(pizzaChart) pizzaChart.destroy();
    if(barraChart) barraChart.destroy();

    pizzaChart=new Chart(pizza,{
      type:'pie',
      data:{labels:Object.keys(cat),datasets:[{data:Object.values(cat)}]}
    });

    barraChart=new Chart(barra,{
      type:'bar',
      data:{labels:Object.keys(cat),datasets:[{data:Object.values(cat),backgroundColor:'#facc15'}]},
      options:{plugins:{legend:{display:false}}}
    });
  });
}

/* ================= AGENDA ================= */
function addLembrete(){
  fetch('/api/lembrete/'+usuario,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      texto:tituloAgenda.value,
      data:dataAgenda.value,
      hora:horaAgenda.value
    })
  }).then(loadAgenda);
}

function loadAgenda(){
  fetch('/api/lembretes/'+usuario)
  .then(r=>r.json())
  .then(l=>{
    listaAgenda.innerHTML='';
    l.forEach(x=>{
      listaAgenda.innerHTML+=`
        <div class="item">${x.texto}<br>
        <small>${x.data} ${x.hora}</small></div>`;
    });
  });
}

/* ================= COFRINHO ================= */
function addCofrinho(){
  fetch('/api/cofrinho/'+usuario,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({nome:nomeMeta.value,total:valorMeta.value})
  }).then(loadCofrinhos);
}

function loadCofrinhos(){
  fetch('/api/cofrinho/'+usuario)
  .then(r=>r.json())
  .then(c=>{
    listaCofrinhos.innerHTML='';
    c.forEach(x=>{
      listaCofrinhos.innerHTML+=`
        <div class="item">${x.nome}<br>
        <small>${real(x.guardado)} / ${real(x.total)}</small></div>`;
    });
  });
}

/* ================= CONTAS ================= */
function addConta(){
  fetch('/api/conta/'+usuario,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      descricao:contaDesc.value,
      valor:contaValor.value,
      vencimento:contaVenc.value
    })
  }).then(loadContas);
}

function loadContas(){
  fetch('/api/contas/'+usuario)
  .then(r=>r.json())
  .then(c=>{
    listaContas.innerHTML='';
    c.forEach(x=>{
      listaContas.innerHTML+=`
        <div class="item">${x.descricao}<br>
        <small>${x.vencimento} â€¢ ${real(x.valor)}</small></div>`;
    });
  });
}

load();
loadAgenda();
</script>

</body>
</html>
