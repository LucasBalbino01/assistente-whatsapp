<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Assistente Financeiro</title>
<link rel="stylesheet" href="/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  .grafico-container{max-width:400px;margin:auto}
  table button{margin:0 4px}
</style>
</head>

<body>
<header>ğŸ’™ Assistente Financeiro</header>

<div class="container">

<div class="card">
  <button onclick="mostrar('gastos')">ğŸ“Š Gastos</button>
  <button onclick="mostrar('graficos')">ğŸ“ˆ GrÃ¡ficos</button>
  <button onclick="mostrar('agenda')">ğŸ—“ï¸ Agenda</button>
  <button onclick="mostrar('cofrinho')">ğŸ¦ Cofrinho</button>
  <button onclick="mostrar('contas')">ğŸ’³ Contas</button>
</div>

<section id="gastos" class="card aba">
<h2>Gastos</h2>
<input id="descricao" placeholder="DescriÃ§Ã£o">
<input id="valor" type="number" placeholder="Valor">
<input id="categoria" placeholder="Categoria">
<button onclick="adicionarGasto()">Adicionar</button>

<table>
<thead>
<tr><th>Data</th><th>Categoria</th><th>DescriÃ§Ã£o</th><th>Valor</th><th>AÃ§Ãµes</th></tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<h3 id="total"></h3>
</section>

<section id="graficos" class="card aba" style="display:none">
<h2>GrÃ¡fico por categoria</h2>
<div class="grafico-container">
<canvas id="graficoPizza"></canvas>
</div>
</section>

<section id="agenda" class="card aba" style="display:none">
<h2>Agenda</h2>
<input id="textoLembrete" placeholder="Lembrete">
<input type="date" id="dataLembrete">
<input type="time" id="horaLembrete">
<button onclick="addLembrete()">Salvar</button>

<ul id="listaLembretes"></ul>
</section>

<section id="cofrinho" class="card aba" style="display:none">
<h2>Cofrinho</h2>
<p>Em breveâ€¦</p>
</section>

<section id="contas" class="card aba" style="display:none">
<h2>Contas a pagar</h2>
<p>Em breveâ€¦</p>
</section>

</div>

<script>
const usuario = location.pathname.split('/').pop();
let grafico;

function mostrar(id){
  document.querySelectorAll('.aba').forEach(a=>a.style.display='none');
  document.getElementById(id).style.display='block';
  if(id==='graficos') carregarGrafico();
}

function br(v){return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}

function carregar(){
fetch('/api/dados/'+usuario).then(r=>r.json()).then(d=>{
let total=0,cat={};
tabela.innerHTML='';
d.movimentos.forEach(g=>{
total+=g.valor;
cat[g.categoria]=(cat[g.categoria]||0)+g.valor;
tabela.innerHTML+=`<tr>
<td>${g.data}</td><td>${g.categoria}</td>
<td>${g.descricao}</td><td>${br(g.valor)}</td>
<td>
<button onclick="edit(${g.id},'${g.descricao}','${g.categoria}',${g.valor})">âœï¸</button>
<button onclick="del(${g.id})">ğŸ—‘ï¸</button>
</td></tr>`;
});
total.innerText='Total: '+br(total);
});
}

function adicionarGasto(){
fetch('/api/gasto/'+usuario,{
method:'POST',headers:{'Content-Type':'application/json'},
body:JSON.stringify({descricao:descricao.value,valor:valor.value,categoria:categoria.value})
}).then(carregar);
}

function del(id){fetch('/api/gasto/'+id,{method:'DELETE'}).then(carregar);}
function edit(id,d,c,v){
const nd=prompt('DescriÃ§Ã£o',d),nc=prompt('Categoria',c),nv=prompt('Valor',v);
fetch('/api/gasto/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},
body:JSON.stringify({descricao:nd,categoria:nc,valor:nv})}).then(carregar);
}

function carregarGrafico(){
fetch('/api/dados/'+usuario).then(r=>r.json()).then(d=>{
const cat={};
d.movimentos.forEach(g=>cat[g.categoria]=(cat[g.categoria]||0)+g.valor);
if(grafico)grafico.destroy();
grafico=new Chart(graficoPizza,{type:'pie',
data:{labels:Object.keys(cat),datasets:[{data:Object.values(cat)}]}});
});
}

function addLembrete(){
fetch('/api/lembrete/'+usuario,{
method:'POST',headers:{'Content-Type':'application/json'},
body:JSON.stringify({texto:textoLembrete.value,data:dataLembrete.value,hora:horaLembrete.value})
}).then(loadLembretes);
}

function loadLembretes(){
fetch('/api/lembretes/'+usuario).then(r=>r.json()).then(l=>{
listaLembretes.innerHTML='';
l.forEach(x=>{
listaLembretes.innerHTML+=`<li>${x.texto} ${x.data} ${x.hora}
<button onclick="delL(${x.id})">ğŸ—‘ï¸</button></li>`;
});
});
}

function delL(id){fetch('/api/lembrete/'+id,{method:'DELETE'}).then(loadLembretes);}

carregar();
loadLembretes();
</script>

</body>
</html>
