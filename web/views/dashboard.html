<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Assistente Financeiro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" href="/icon-512.png">
<link rel="stylesheet" href="/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  background:#020617;
  color:#e5e7eb;
  font-family:'Segoe UI',Arial,sans-serif;
}
header{
  padding:18px;
  text-align:center;
  font-size:20px;
  font-weight:600;
  border-bottom:1px solid #1e293b;
}
.container{
  padding:16px;
  padding-bottom:100px;
}
.aba{display:none}
.card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:18px;
  padding:18px;
  margin-bottom:16px;
}
input{
  width:100%;
  padding:14px;
  margin-bottom:10px;
  border-radius:12px;
  border:1px solid #334155;
  background:#020617;
  color:#e5e7eb;
}
button{
  width:100%;
  padding:14px;
  border-radius:999px;
  border:none;
  background:#facc15;
  color:#020617;
  font-weight:600;
  margin-top:8px;
}
button.danger{
  background:#ef4444;
  color:white;
}
button.edit{
  background:#334155;
  color:#e5e7eb;
}
.item{
  padding:14px;
  border-bottom:1px solid #1e293b;
}
.item small{
  opacity:.7;
  display:block;
}
.actions{
  display:flex;
  gap:8px;
  margin-top:8px;
}

/* ====== TOTAIS TOPO ====== */
.totais{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-bottom:20px;
}
.total-card{
  padding:16px;
  border-radius:16px;
  border:1px solid #1e293b;
}
.total-card.gasto{
  background:linear-gradient(135deg,#450a0a,#020617);
}
.total-card.cofre{
  background:linear-gradient(135deg,#3f2f00,#020617);
}
.total-card span{
  font-size:13px;
  opacity:.8;
}
.total-card strong{
  display:block;
  font-size:22px;
  margin-top:6px;
}

/* ====== MENU APP ====== */
.nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#020617;
  border-top:1px solid #1e293b;
  display:flex;
  justify-content:space-around;
  padding:10px 0;
}
.nav button{
  background:none;
  color:#e5e7eb;
  font-size:12px;
  padding:0;
}

canvas{max-width:100%}
</style>
</head>

<body>

<header>ğŸ’™ Assistente Financeiro</header>

<div class="container">

<!-- ===== TOTAIS ===== -->
<div class="totais">
  <div class="total-card gasto">
    <span>ğŸ’¸ Total gasto</span>
    <strong id="totalGasto">R$ 0,00</strong>
  </div>
  <div class="total-card cofre">
    <span>ğŸ¦ Total no cofrinho</span>
    <strong id="totalCofrinho">R$ 0,00</strong>
  </div>
</div>

<!-- ================= GASTOS ================= -->
<section id="gastos" class="aba" style="display:block">
  <div class="card">
    <h3>ğŸ“Š Gastos</h3>
    <input id="descricao" placeholder="DescriÃ§Ã£o">
    <input id="valor" type="number" placeholder="Valor">
    <input id="categoria" placeholder="Categoria">
    <button onclick="addGasto()">Adicionar gasto</button>
  </div>

  <div class="card">
    <canvas id="graficoPizza"></canvas>
    <canvas id="graficoBarra" style="margin-top:20px"></canvas>
  </div>

  <div id="listaGastos"></div>
</section>

<!-- ================= AGENDA ================= -->
<section id="agenda" class="aba">
  <div class="card">
    <h3>ğŸ—“ï¸ Agenda</h3>
    <input id="tituloAgenda" placeholder="TÃ­tulo">
    <input id="dataAgenda" type="date">
    <input id="horaAgenda" type="time">
    <button onclick="addLembrete()">Adicionar lembrete</button>
  </div>
  <div id="listaAgenda"></div>
</section>

<!-- ================= COFRINHO ================= -->
<section id="cofrinho" class="aba">
  <div class="card">
    <h3>ğŸ¦ Cofrinho</h3>
    <input id="nomeMeta" placeholder="Nome da meta">
    <input id="valorMeta" type="number" placeholder="Valor total">
    <button onclick="addCofrinho()">Criar meta</button>
  </div>
  <div id="listaCofrinhos"></div>
</section>

<!-- ================= CONTAS ================= -->
<section id="contas" class="aba">
  <div class="card">
    <h3>ğŸ’³ Contas a pagar</h3>
    <input id="contaDesc" placeholder="DescriÃ§Ã£o">
    <input id="contaValor" type="number" placeholder="Valor">
    <input id="contaVenc" type="date">
    <button onclick="addConta()">Adicionar conta</button>
  </div>
  <div id="listaContas"></div>
</section>

</div>

<div class="nav">
  <button onclick="show('gastos')">ğŸ“Š<br>Gastos</button>
  <button onclick="show('agenda')">ğŸ—“ï¸<br>Agenda</button>
  <button onclick="show('cofrinho')">ğŸ¦<br>Cofrinho</button>
  <button onclick="show('contas')">ğŸ’³<br>Contas</button>
</div>

<script>
const usuario = location.pathname.split('/').pop();
let pizzaChart, barraChart;

function show(id){
  document.querySelectorAll('.aba').forEach(a=>a.style.display='none');
  document.getElementById(id).style.display='block';
}

function real(v){
  return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
}

/* ================= GASTOS ================= */
function addGasto(){
  fetch('/api/gasto/'+usuario,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      descricao:descricao.value,
      valor:valor.value,
      categoria:categoria.value
    })
  }).then(loadGastos);
}

function loadGastos(){
  fetch('/api/dados/'+usuario)
  .then(r=>r.json())
  .then(d=>{
    listaGastos.innerHTML='';
    let total=0;
    const cat={}, datas={};

    d.movimentos.forEach(g=>{
      total+=g.valor;

      listaGastos.innerHTML+=`
      <div class="item">
        <strong>${g.descricao}</strong>
        <small>${g.categoria} â€¢ ${real(g.valor)}</small>
        <div class="actions">
          <button class="edit" onclick="editGasto(${g.id},'${g.descricao}','${g.categoria}',${g.valor})">Editar</button>
          <button class="danger" onclick="delGasto(${g.id})">Excluir</button>
        </div>
      </div>`;

      cat[g.categoria]=(cat[g.categoria]||0)+g.valor;
      datas[g.data]=(datas[g.data]||0)+g.valor;
    });

    totalGasto.innerText=real(total);
    renderPizza(cat);
    renderBarra(datas);
  });
}

function delGasto(id){
  fetch('/api/gasto/'+id,{method:'DELETE'}).then(loadGastos);
}

function editGasto(id,d,c,v){
  const nd=prompt('DescriÃ§Ã£o',d);
  const nc=prompt('Categoria',c);
  const nv=prompt('Valor',v);
  if(!nd||!nc||!nv)return;
  fetch('/api/gasto/'+id,{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({descricao:nd,categoria:nc,valor:nv})
  }).then(loadGastos);
}

/* ================= GRÃFICOS ================= */
function renderPizza(data){
  if(pizzaChart)pizzaChart.destroy();
  pizzaChart=new Chart(graficoPizza,{
    type:'pie',
    data:{labels:Object.keys(data),datasets:[{data:Object.values(data)}]}
  });
}
function renderBarra(data){
  if(barraChart)barraChart.destroy();
  barraChart=new Chart(graficoBarra,{
    type:'bar',
    data:{labels:Object.keys(data),datasets:[{data:Object.values(data)}]}
  });
}

/* ================= COFRINHO ================= */
function loadCofrinhos(){
  fetch('/api/cofrinho/'+usuario)
  .then(r=>r.json())
  .then(c=>{
    let total=0;
    listaCofrinhos.innerHTML='';
    c.forEach(x=>{
      total+=x.guardado;
      listaCofrinhos.innerHTML+=`
      <div class="item">
        <strong>${x.nome}</strong>
        <small>${real(x.guardado)} / ${real(x.total)}</small>
        <button class="danger" onclick="delCofrinho(${x.id})">Excluir</button>
      </div>`;
    });
    totalCofrinho.innerText=real(total);
  });
}

function addCofrinho(){
  fetch('/api/cofrinho/'+usuario,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({nome:nomeMeta.value,total:valorMeta.value})
  }).then(loadCofrinhos);
}

function delCofrinho(id){
  fetch('/api/cofrinho/'+id,{method:'DELETE'}).then(loadCofrinhos);
}

/* ================= CONTAS ================= */
function addConta(){
  fetch('/api/conta/'+usuario,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      descricao:contaDesc.value,
      valor:contaValor.value,
      vencimento:contaVenc.value
    })
  }).then(loadContas);
}
function loadContas(){
  fetch('/api/contas/'+usuario)
  .then(r=>r.json())
  .then(c=>{
    listaContas.innerHTML='';
    c.forEach(x=>{
      listaContas.innerHTML+=`
      <div class="item">
        <strong>${x.descricao}</strong>
        <small>${x.vencimento} â€¢ ${real(x.valor)}</small>
        <button class="danger" onclick="delConta(${x.id})">Excluir</button>
      </div>`;
    });
  });
}
function delConta(id){
  fetch('/api/conta/'+id,{method:'DELETE'}).then(loadContas);
}

/* ================= AGENDA ================= */
function addLembrete(){
  fetch('/api/lembrete/'+usuario,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      titulo:tituloAgenda.value,
      data:dataAgenda.value,
      hora:horaAgenda.value
    })
  }).then(loadAgenda);
}
function loadAgenda(){
  fetch('/api/lembretes/'+usuario)
  .then(r=>r.json())
  .then(l=>{
    listaAgenda.innerHTML='';
    l.forEach(x=>{
      listaAgenda.innerHTML+=`
      <div class="item">
        <strong>${x.titulo}</strong>
        <small>${x.data} ${x.hora}</small>
        <button class="danger" onclick="delLembrete(${x.id})">Excluir</button>
      </div>`;
    });
  });
}
function delLembrete(id){
  fetch('/api/lembrete/'+id,{method:'DELETE'}).then(loadAgenda);
}

loadGastos();
loadCofrinhos();
</script>

</body>
</html>
