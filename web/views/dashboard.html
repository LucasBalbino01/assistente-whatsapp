<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Assistente Financeiro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" href="/icon-512.png">
<link rel="stylesheet" href="/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  background:#020617;
  color:#e5e7eb;
  font-family:'Segoe UI',Arial,sans-serif;
}

header{
  padding:16px;
  text-align:center;
  font-size:20px;
  font-weight:600;
  border-bottom:1px solid #1e293b;
}

.container{
  padding:16px;
  padding-bottom:90px;
}

.aba{display:none;}

.card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:18px;
  padding:18px;
  margin-bottom:16px;
}

input{
  width:100%;
  padding:14px;
  margin-bottom:10px;
  border-radius:12px;
  border:1px solid #334155;
  background:#020617;
  color:#e5e7eb;
}

button{
  width:100%;
  padding:14px;
  border-radius:999px;
  border:none;
  background:#facc15;
  color:#020617;
  font-weight:600;
  margin-top:8px;
}

.item{
  padding:12px;
  border-bottom:1px solid #1e293b;
}

.nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#020617;
  border-top:1px solid #1e293b;
  display:flex;
  justify-content:space-around;
  padding:10px 0;
}

.nav button{
  background:none;
  color:#e5e7eb;
  font-size:12px;
  padding:0;
}
</style>
</head>

<body>

<header>ğŸ’™ Assistente Financeiro</header>

<div class="container">

<!-- ================= GASTOS ================= -->
<section id="gastos" class="aba" style="display:block">
  <div class="card">
    <h3>ğŸ“Š Gastos</h3>
    <input id="descricao" placeholder="DescriÃ§Ã£o">
    <input id="valor" type="number" placeholder="Valor">
    <input id="categoria" placeholder="Categoria">
    <button onclick="addGasto()">Adicionar</button>
  </div>

  <div class="card">
    <canvas id="graficoBarra"></canvas>
  </div>

  <div class="card">
    <canvas id="graficoPizza"></canvas>
  </div>

  <div id="listaGastos"></div>
</section>

<!-- ================= AGENDA ================= -->
<section id="agenda" class="aba">
  <div class="card">
    <h3>ğŸ—“ï¸ Agenda</h3>
    <input id="tituloAgenda" placeholder="TÃ­tulo">
    <input id="dataAgenda" type="date">
    <input id="horaAgenda" type="time">
    <button onclick="addLembrete()">Salvar</button>
  </div>

  <div id="listaAgenda"></div>
</section>

<!-- ================= COFRINHO ================= -->
<section id="cofrinho" class="aba">
  <div class="card">
    <h3>ğŸ¦ Cofrinho</h3>
    <input id="nomeMeta" placeholder="Meta">
    <input id="valorMeta" type="number" placeholder="Valor total">
    <button onclick="addCofrinho()">Criar</button>
  </div>

  <div id="listaCofrinhos"></div>
</section>

<!-- ================= CONTAS ================= -->
<section id="contas" class="aba">
  <div class="card">
    <h3>ğŸ’³ Contas a pagar</h3>
    <input id="contaDesc" placeholder="DescriÃ§Ã£o">
    <input id="contaValor" type="number" placeholder="Valor">
    <input id="contaVenc" type="date">
    <button onclick="addConta()">Adicionar</button>
  </div>

  <div id="listaContas"></div>
</section>

</div>

<!-- ================= MENU ================= -->
<div class="nav">
  <button onclick="show('gastos')">ğŸ“Š<br>Gastos</button>
  <button onclick="show('agenda')">ğŸ—“ï¸<br>Agenda</button>
  <button onclick="show('cofrinho')">ğŸ¦<br>Cofrinho</button>
  <button onclick="show('contas')">ğŸ’³<br>Contas</button>
</div>

<script>
const usuario = location.pathname.split('/').pop();
let graficoBarra, graficoPizza;

/* ====== NAVEGAÃ‡ÃƒO ====== */
function show(id){
  document.querySelectorAll('.aba').forEach(a=>a.style.display='none');
  document.getElementById(id).style.display='block';
  if(id==='gastos') carregarTudo();
}

/* ====== GASTOS ====== */
function addGasto(){
  fetch('/api/gasto/'+usuario,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      descricao:descricao.value,
      valor:valor.value,
      categoria:categoria.value
    })
  }).then(carregarTudo);
}

function carregarTudo(){
  fetch('/api/dados/'+usuario)
  .then(r=>r.json())
  .then(d=>{
    listaGastos.innerHTML='';
    const cat={};

    d.movimentos.forEach(g=>{
      listaGastos.innerHTML+=`
      <div class="item">
        ${g.descricao}<br>
        <small>${g.categoria} â€¢ R$ ${g.valor}</small>
      </div>`;
      cat[g.categoria]=(cat[g.categoria]||0)+g.valor;
    });

    renderGraficos(cat);
  });
}

/* ====== GRÃFICOS ====== */
function renderGraficos(cat){
  if(graficoBarra)graficoBarra.destroy();
  if(graficoPizza)graficoPizza.destroy();

  graficoBarra=new Chart(graficoBarra,{
    type:'bar',
    data:{
      labels:Object.keys(cat),
      datasets:[{
        data:Object.values(cat),
        backgroundColor:'#facc15',
        borderRadius:8
      }]
    },
    options:{plugins:{legend:{display:false}}}
  });

  graficoPizza=new Chart(graficoPizza,{
    type:'pie',
    data:{
      labels:Object.keys(cat),
      datasets:[{data:Object.values(cat)}]
    }
  });
}

/* ====== AGENDA ====== */
function addLembrete(){
  fetch('/api/lembrete/'+usuario,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      texto:tituloAgenda.value,
      data:dataAgenda.value,
      hora:horaAgenda.value
    })
  }).then(loadAgenda);
}

function loadAgenda(){
  fetch('/api/lembretes/'+usuario)
  .then(r=>r.json())
  .then(l=>{
    listaAgenda.innerHTML='';
    l.forEach(x=>{
      listaAgenda.innerHTML+=`
      <div class="item">${x.texto}<br>
      <small>${x.data} ${x.hora}</small></div>`;
    });
  });
}

/* ====== COFRINHO ====== */
function addCofrinho(){
  fetch('/api/cofrinho/'+usuario,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({nome:nomeMeta.value,total:valorMeta.value})
  }).then(loadCofrinhos);
}

function loadCofrinhos(){
  fetch('/api/cofrinho/'+usuario)
  .then(r=>r.json())
  .then(c=>{
    listaCofrinhos.innerHTML='';
    c.forEach(x=>{
      listaCofrinhos.innerHTML+=`
      <div class="item">
        ${x.nome}<br>
        <small>R$ ${x.guardado} / ${x.total}</small>
      </div>`;
    });
  });
}

/* ====== CONTAS ====== */
function addConta(){
  fetch('/api/conta/'+usuario,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      descricao:contaDesc.value,
      valor:contaValor.value,
      vencimento:contaVenc.value
    })
  }).then(loadContas);
}

function loadContas(){
  fetch('/api/contas/'+usuario)
  .then(r=>r.json())
  .then(c=>{
    listaContas.innerHTML='';
    c.forEach(x=>{
      listaContas.innerHTML+=`
      <div class="item">
        ${x.descricao}<br>
        <small>${x.vencimento} â€¢ R$ ${x.valor}</small>
      </div>`;
    });
  });
}

carregarTudo();
</script>

</body>
</html>
